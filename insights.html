<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insights - Bill Reminder</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/config.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-dark: #3a56d4;
            --secondary-color: #48bfe3;
            --light-color: #f8f9fa;
            --dark-color: #1a1a2e;
            --success-color: #06d6a0;
            --warning-color: #ffd166;
            --danger-color: #ef476f;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --sidebar-width: 240px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f4f7fc;
            transition: all 0.3s;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: var(--dark-color);
            color: white;
            padding-top: 20px;
            z-index: 100;
            transition: all 0.3s;
            box-shadow: 3px 0px 10px rgba(0,0,0,0.1);
        }

        .sidebar .logo-container {
            padding: 15px 25px;
            margin-bottom: 25px;
        }

        .sidebar .logo-container h4 {
            margin: 0;
            font-weight: 600;
            font-size: 1.4rem;
            letter-spacing: 0.5px;
        }

        .sidebar .nav-link {
            color: rgba(255,255,255,0.7);
            padding: 12px 25px;
            margin: 3px 0;
            border-radius: 0 30px 30px 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.1);
        }

        .sidebar .nav-link.active {
            background-color: var(--primary-color);
        }

        .sidebar .nav-link i {
            margin-right: 15px;
            width: 24px;
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 30px;
            transition: all 0.3s;
            min-height: 100vh;
        }

        .page-title {
            margin-bottom: 30px;
            color: var(--dark-color);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title h2 {
            font-weight: 600;
            margin-bottom: 0;
        }

        /* Card Styles */
        .custom-card {
            background: white;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            transition: all 0.3s;
            border: none;
            overflow: hidden;
        }

        .custom-card:hover {
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            transform: translateY(-3px);
        }

        .custom-card .card-header {
            background: transparent;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .custom-card .card-header .header-title {
            display: flex;
            align-items: center;
        }

        .custom-card .card-header h5 {
            margin: 0;
            font-weight: 600;
        }

        .card-header .header-icon {
            margin-right: 15px;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        /* Insights Specific Styles */
        .stat-card {
            background: white;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            padding: 20px;
            transition: all 0.3s;
            height: 100%;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .stat-card h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #555;
        }

        .stat-card .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0;
            color: var(--primary-color);
        }

        .stat-card .stat-label {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }

        .stat-card .icon-container {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(67, 97, 238, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .stat-card .icon-container i {
            font-size: 1.3rem;
            color: var(--primary-color);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        /* Loading Spinner */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            margin-bottom: 15px;
        }

        /* Suggestion Styles */
        .suggestion-card {
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--success-color);
        }

        .suggestion-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark-color);
        }

        .suggestion-list {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 0;
        }

        .suggestion-list li {
            position: relative;
            padding-left: 25px;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .suggestion-list li:before {
            content: '\f00c';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            left: 0;
            color: var(--success-color);
        }

        /* Time Period Selector */
        .time-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .time-selector .btn-group .btn {
            padding: 8px 15px;
            font-size: 0.9rem;
            background-color: white;
            color: #666;
            border: 1px solid #ddd;
            box-shadow: none;
        }

        .time-selector .btn-group .btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Free Alternatives Section Styles */
        .free-alternatives-section {
            margin-bottom: 30px;
            padding: 0 10px;
        }

        .free-alternatives-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .free-alternatives-header h3 {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .free-alternatives-subtitle {
            font-size: 1rem;
            color: #777;
            max-width: 600px;
            margin: 0 auto 20px;
        }

        .alternatives-slider {
            overflow-x: auto;
            padding: 10px 5px 20px;
            white-space: nowrap;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) #f0f0f0;
        }

        .alternatives-slider::-webkit-scrollbar {
            height: 8px;
        }

        .alternatives-slider::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 20px;
        }

        .alternatives-slider::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 20px;
        }

        .alternative-card {
            display: inline-flex;
            align-items: center;
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-right: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            transition: all 0.3s;
            position: relative;
            white-space: normal;
            width: 340px;
            min-height: 160px; /* Use min-height instead of fixed height to prevent stretching */
            vertical-align: top;
            border: 1px solid rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
        }

        .dark-mode .alternative-card {
            background: #1e1e1e;
            border-color: rgba(255,255,255,0.05);
        }

        .alternative-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(67, 97, 238, 0.15);
            border-color: rgba(67, 97, 238, 0.1);
        }

        .paid-service, .free-service {
            text-align: center;
            padding: 10px;
            width: 130px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center; /* Keep content centered */
        }

        .service-logo {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            height: 64px;
            border-radius: 16px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            position: relative;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            transition: all 0.3s;
        }

        .alternative-card:hover .service-logo {
            transform: scale(1.05);
        }

        .service-logo.premium {
            background: linear-gradient(135deg, #1DB954 0%, #1ed760 100%);
        }

        .service-logo.youtube {
            background: linear-gradient(135deg, #FF0000 0%, #FF5E3A 100%);
        }

        .service-logo.netflix {
            background: linear-gradient(135deg, #E50914 0%, #B81D24 100%);
        }

        .service-logo.tubi {
            background: linear-gradient(135deg, #F12B24 0%, #FF6B58 100%);
        }

        .service-logo.disney {
            background: linear-gradient(135deg, #0E6CD9 0%, #1A46CF 100%);
        }

        .service-logo.roku {
            background: linear-gradient(135deg, #662D91 0%, #8C52FF 100%);
        }

        .service-logo.amazon {
            background: linear-gradient(135deg, #00A8E1 0%, #0082B4 100%);
        }

        .service-logo.pluto {
            background: linear-gradient(135deg, #FFCD00 0%, #FFB100 100%);
            color: #333;
        }

        .service-logo.office {
            background: linear-gradient(135deg, #D83B01 0%, #FF5722 100%);
        }

        .service-logo.libre {
            background: linear-gradient(135deg, #18A303 0%, #3CCA24 100%);
        }

        .service-premium-tag {
            position: absolute;
            top: -8px;
            right: -8px;
            background: rgba(0,0,0,0.5);
            color: white;
            font-size: 0.6rem;
            font-weight: 600;
            padding: 3px 6px;
            border-radius: 10px;
            text-transform: uppercase;
        }

        .service-free-tag {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--success-color);
            color: white;
            font-size: 0.6rem;
            font-weight: 600;
            padding: 3px 6px;
            border-radius: 10px;
            text-transform: uppercase;
        }

        .service-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 5px;
            height: 2.4em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .service-price {
            font-size: 0.8rem;
            color: #666;
        }

        .dark-mode .service-price {
            color: #aaa;
        }

        .service-price.free {
            color: var(--success-color);
            font-weight: 700;
        }

        .alternative-arrow {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 10px;
            color: var(--primary-color);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(67, 97, 238, 0.1);
            transition: all 0.3s;
        }

        .alternative-card:hover .alternative-arrow {
            background: rgba(67, 97, 238, 0.2);
            transform: scale(1.1);
        }

        .alternative-arrow i {
            font-size: 1.2rem;
        }

        .savings-badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--success-color) 0%, #04a57a 100%);
            color: white;
            font-size: 0.8rem;
            font-weight: 700;
            padding: 5px 15px;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(6, 214, 160, 0.3);
            white-space: nowrap;
            z-index: 1;
            border: 2px solid white;
            letter-spacing: 0.5px;
        }

        .dark-mode .savings-badge {
            border-color: #1e1e1e;
        }

        .alternative-arrow {
            display: flex;
            justify-content: center;
            margin: 0 5px;
            color: var(--primary-color);
        }

        .savings-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--success-color) 0%, #04a57a 100%);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 5px 10px;
            border-radius: 20px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            white-space: nowrap;
        }

        @media (max-width: 576px) {
            .alternative-card {
                width: 270px;
            }
            
            .service-logo {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
        }

        /* Category Legend */
        .category-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 15px;
            font-size: 0.9rem;
        }

        .color-indicator {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 5px;
        }

        /* Theme Switch Button */
        .theme-switch {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--dark-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .theme-switch:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        /* Dark Mode Styles */
        .dark-mode {
            background-color: #121212;
            color: #f5f5f5;
        }

        .dark-mode .custom-card,
        .dark-mode .stat-card {
            background-color: #1e1e1e;
            color: #f5f5f5;
        }

        .dark-mode .page-title {
            color: #f5f5f5;
            border-bottom-color: #333;
        }

        .dark-mode .custom-card .card-header {
            border-bottom-color: #333;
        }

        .dark-mode .stat-card h4 {
            color: #aaa;
        }

        .dark-mode .stat-card .stat-label {
            color: #888;
        }

        .dark-mode .suggestion-card {
            background-color: #2a2a2a;
            border-left-color: var(--success-color);
        }

        .dark-mode .suggestion-title {
            color: #f5f5f5;
        }

        .dark-mode .time-selector .btn-group .btn {
            background-color: #1e1e1e;
            color: #aaa;
            border-color: #333;
        }

        .dark-mode .theme-switch {
            background-color: var(--light-color);
            color: var(--dark-color);
        }

        .dark-mode .text-muted {
            color: #aaa !important;
        }

        /* Media Queries for Responsive Design */
        @media (max-width: 992px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar .logo-container h4,
            .sidebar .nav-link span {
                display: none;
            }
            
            .sidebar .nav-link {
                padding: 15px 0;
                justify-content: center;
            }
            
            .sidebar .nav-link i {
                margin-right: 0;
                font-size: 1.2rem;
            }
            
            .main-content {
                margin-left: 70px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .page-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .chart-container {
                height: 250px;
            }
            
            .stat-rows {
                flex-direction: column;
            }
            
            .stat-card {
                margin-bottom: 15px;
            }
        }

        @media (max-width: 576px) {
            .sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                top: auto;
                width: 100%;
                height: 60px;
                display: flex;
                flex-direction: row;
                padding: 0;
                z-index: 1000;
            }
            
            .sidebar .logo-container {
                display: none;
            }
            
            .sidebar .nav {
                display: flex;
                flex-direction: row;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            
            .sidebar .nav-item {
                flex: 1;
            }
            
            .sidebar .nav-link {
                padding: 10px 0;
                text-align: center;
                border-radius: 0;
                height: 60px;
                justify-content: center;
                align-items: center;
                flex-direction: column;
            }
            
            .sidebar .nav-link i {
                margin: 0 0 5px 0;
                font-size: 1.1rem;
            }
            
            .sidebar .nav-link span {
                display: block;
                font-size: 0.7rem;
            }
            
            .main-content {
                margin-left: 0;
                padding-bottom: 80px;
            }
            
            .page-title h2 {
                font-size: 1.5rem;
            }
            
            .chart-container {
                height: 220px;
            }
        }

        /* Category Comparison Chart - make it larger */
        .comparison-chart-container {
            height: 350px !important; /* Increase height for better visibility */
            margin-bottom: 20px;
        }
        
        /* Top categories progress bars */
        .category-progress {
            height: 12px;
            border-radius: 6px;
            margin-bottom: 5px;
        }
        
        .category-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }
        
        .category-label .name {
            font-weight: 500;
        }
        
        .category-label .amount {
            color: #666;
        }
        
        .dark-mode .category-label .amount {
            color: #aaa;
        }

        /* Add styles for average spending info */
        .avg-spending-info {
            margin-top: 15px;
            padding: 15px;
            background-color: rgba(67, 97, 238, 0.05);
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .avg-spending-info h6 {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .dark-mode .avg-spending-info {
            background-color: rgba(67, 97, 238, 0.15);
        }
    </style>
</head>
<body>
    <!-- Theme Switch Button -->
    <div class="theme-switch" id="themeSwitch">
        <i class="fas fa-moon"></i>
    </div>

    <!-- Sidebar Navigation -->
    <nav class="sidebar">
        <div class="logo-container">
            <h4><i class="fas fa-receipt mr-2"></i> BillTracker</h4>
        </div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-chart-pie"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="add-bill.html" class="nav-link">
                    <i class="fas fa-plus-circle"></i>
                    <span>Add Bill</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="bill-history.html" class="nav-link">
                    <i class="fas fa-history"></i>
                    <span>Bill History</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="ai-chat.html" class="nav-link">
                    <i class="fas fa-robot"></i>
                    <span>AI Assistant</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="reminders.html" class="nav-link">
                    <i class="fas fa-bell"></i>
                    <span>Reminders</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="insights.html" class="nav-link active">
                    <i class="fas fa-lightbulb"></i>
                    <span>Insights</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content">
        <div class="page-title">
            <div>
                <h2>Spending Insights</h2>
                <p class="text-muted">Analyze your spending patterns and get personalized suggestions</p>
            </div>
            <div style="margin-right: 50px;">
                <button class="btn btn-primary" id="refreshInsights">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh Data
                </button>
            </div>
        </div>
        
        <!-- Time Period Selector -->
        <div class="time-selector">
            <div class="btn-group" role="group" aria-label="Time period">
                <button type="button" class="btn" data-period="month">This Month</button>
                <button type="button" class="btn active" data-period="quarter">Quarter</button>
                <button type="button" class="btn" data-period="year">Year</button>
                <button type="button" class="btn" data-period="all">All Time</button>
            </div>
        </div>

        <!-- Free Alternatives Section (NEW) -->
        <div class="free-alternatives-section">
            <div class="free-alternatives-header">
                <h3><i class="fas fa-exchange-alt mr-2"></i>Save Money With Free Alternatives</h3>
                <p class="free-alternatives-subtitle">AI-powered suggestions based on your bills to save money with free alternatives</p>
            </div>
            
            <div class="alternatives-slider" id="alternativesSlider">
                <!-- Loading indicator -->
                <div class="text-center w-100 py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Finding alternatives...</span>
                    </div>
                    <p class="mt-3 text-muted">Analyzing your bills for potential savings...</p>
                </div>
                <!-- Alternatives will be added here dynamically -->
            </div>
        </div>
        
        <!-- Stats Cards Row -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="icon-container">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <h4>Total Spending</h4>
                    <p class="stat-value" id="totalSpending">$0.00</p>
                    <p class="stat-label">All categories combined</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="icon-container">
                        <i class="fas fa-arrow-trend-up"></i>
                    </div>
                    <h4>Highest Category</h4>
                    <p class="stat-value" id="highestCategory">-</p>
                    <p class="stat-label">Your biggest expense</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="icon-container">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <h4>Average Monthly</h4>
                    <p class="stat-value" id="avgMonthly">$0.00</p>
                    <p class="stat-label">Monthly average</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="icon-container">
                        <i class="fas fa-piggy-bank"></i>
                    </div>
                    <h4>Potential Savings</h4>
                    <p class="stat-value" id="potentialSavings">$0.00</p>
                    <p class="stat-label">Estimated monthly savings</p>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Category Breakdown Chart -->
            <div class="col-lg-8 mb-4">
                <div class="custom-card">
                    <div class="card-header">
                        <div class="header-title">
                            <i class="fas fa-chart-pie header-icon"></i>
                            <h5>Spending by Category</h5>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                        <div class="category-legend" id="categoryLegend">
                            <!-- Legend items will be added here dynamically -->
                        </div>
                    </div>
                </div>
                
                <!-- Category Comparison - Moved here from the right column -->
                <div class="custom-card">
                    <div class="card-header">
                        <div class="header-title">
                            <i class="fas fa-balance-scale header-icon"></i>
                            <h5>Category Comparison</h5>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" id="refreshComparison">
                                <i class="fas fa-sync-alt mr-1"></i> Update
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container comparison-chart-container">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                        <div class="avg-spending-info">
                            <h6><i class="fas fa-info-circle mr-2"></i>How You Compare</h6>
                            <p id="comparisonInsight">Loading comparison insights...</p>
                        </div>
                        <div class="text-center mt-3">
                            <small class="text-muted">Based on actual spending data across all users</small>
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Trend Chart -->
                <div class="custom-card">
                    <div class="card-header">
                        <div class="header-title">
                            <i class="fas fa-chart-line header-icon"></i>
                            <h5>Monthly Spending Trend</h5>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Saving Suggestions -->
            <div class="col-lg-4 mb-4">
                <div class="custom-card">
                    <div class="card-header">
                        <div class="header-title">
                            <i class="fas fa-lightbulb header-icon"></i>
                            <h5>AI-Powered Saving Tips</h5>
                        </div>
                    </div>
                    <div class="card-body" id="suggestionsContainer">
                        <div class="loading-container">
                            <div class="spinner-border text-primary loading-spinner" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <p class="text-muted">Generating personalized suggestions...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Insights Card - New card that replaces the moved comparison chart -->
                <div class="custom-card">
                    <div class="card-header">
                        <div class="header-title">
                            <i class="fas fa-chart-bar header-icon"></i>
                            <h5>Spending Insights</h5>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Top Categories Section -->
                        <div class="mb-4">
                            <h6 class="mb-3">Top Spending Categories</h6>
                            <div id="topCategoriesContainer">
                                <div class="d-flex justify-content-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    <span class="ml-2">Loading categories...</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Spending Trends Section -->
                        <div>
                            <h6 class="mb-3">Spending Trend</h6>
                            <p id="trendInsight" class="text-muted">
                                <i class="fas fa-info-circle mr-2"></i>
                                Analyzing your spending patterns...
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Required JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="js/footer.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Theme toggling
            const themeSwitch = document.getElementById('themeSwitch');
            if (themeSwitch) {
                themeSwitch.addEventListener('click', function() {
                    document.body.classList.toggle('dark-mode');
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    localStorage.setItem('darkMode', isDarkMode);
                    
                    const icon = themeSwitch.querySelector('i');
                    if (isDarkMode) {
                        icon.className = 'fas fa-sun';
                    } else {
                        icon.className = 'fas fa-moon';
                    }
                    
                    // Update charts for dark mode
                    updateChartsTheme(isDarkMode);
                });
                
                // Restore dark mode preference
                if (localStorage.getItem('darkMode') === 'true') {
                    document.body.classList.add('dark-mode');
                    const icon = themeSwitch.querySelector('i');
                    if (icon) {
                        icon.className = 'fas fa-sun';
                    }
                }
            }
            
            // Chart instances
            let categoryChart = null;
            let trendChart = null;
            let comparisonChart = null;
            
            // Colors for categories
            const categoryColors = {
                'Utilities': 'rgba(67, 97, 238, 0.7)',
                'Entertainment': 'rgba(239, 71, 111, 0.7)',
                'Subscriptions': 'rgba(255, 209, 102, 0.7)', 
                'Insurance': 'rgba(6, 214, 160, 0.7)', 
                'Rent': 'rgba(17, 138, 178, 0.7)', 
                'Transportation': 'rgba(155, 89, 182, 0.7)',
                'Food': 'rgba(46, 204, 113, 0.7)',
                'Other': 'rgba(108, 117, 125, 0.7)'
            };
            
            // Fetch insights data
            fetchInsights();
            
            // Event listeners
            document.getElementById('refreshInsights').addEventListener('click', fetchInsights);
            
            // Add refresh comparison chart button handler
            document.getElementById('refreshComparison').addEventListener('click', function() {
                const activeButton = document.querySelector('.time-selector .btn.active');
                const currentPeriod = activeButton ? activeButton.getAttribute('data-period') : 'quarter';
                
                // Show loading in the comparison insight area
                document.getElementById('comparisonInsight').innerHTML = 
                    '<div class="text-center"><div class="spinner-border spinner-border-sm text-primary mr-2" role="status"></div> Updating comparison data...</div>';
                
                // Fetch fresh data and update the chart
                fetch(`${getApiBaseUrl()}/insights?period=` + currentPeriod)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to refresh data');
                        }
                        return response.json();
                    })
                    .then(data => {
                        updateComparisonChart(data.category_percentages);
                    })
                    .catch(error => {
                        console.error('Error refreshing comparison:', error);
                        document.getElementById('comparisonInsight').innerHTML = 
                            `<div class="text-danger"><i class="fas fa-exclamation-circle mr-1"></i> Error updating: ${error.message}</div>`;
                    });
            });
            
            // Time period buttons
            document.querySelectorAll('.time-selector .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    document.querySelectorAll('.time-selector .btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Fetch insights with the selected time period
                    fetchInsights(this.getAttribute('data-period'));
                });
            });
            
            // Function to fetch insights from API
            function fetchInsights(period = 'quarter') {
                // Show loading indicators
                document.getElementById('totalSpending').textContent = '$0.00';
                document.getElementById('highestCategory').textContent = '-';
                document.getElementById('avgMonthly').textContent = '$0.00';
                document.getElementById('potentialSavings').textContent = '$0.00';
                document.getElementById('suggestionsContainer').innerHTML = `
                    <div class="loading-container">
                        <div class="spinner-border text-primary loading-spinner" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="text-muted">Generating personalized suggestions...</p>
                    </div>
                `;
                
                // Fetch free alternatives
                fetchFreeAlternatives();
                
                // Call API
                fetch(`${getApiBaseUrl()}/insights?period=` + period)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Update stats
                        document.getElementById('totalSpending').textContent = '$' + parseFloat(data.total_spent).toFixed(2);
                        document.getElementById('highestCategory').textContent = data.highest_spending_category.name;
                        
                        // Calculate monthly average (using a simple estimate)
                        let monthlyAvg = data.total_spent;
                        if (period === 'quarter') monthlyAvg /= 3;
                        if (period === 'year') monthlyAvg /= 12;
                        document.getElementById('avgMonthly').textContent = '$' + parseFloat(monthlyAvg).toFixed(2);
                        
                        // Rough estimate of potential savings (10% of highest category)
                        const potentialSavings = data.highest_spending_category.amount * 0.1;
                        document.getElementById('potentialSavings').textContent = '$' + parseFloat(potentialSavings).toFixed(2);
                        
                        // Update category chart
                        updateCategoryChart(data.category_breakdown);
                        
                        // Create legend
                        createCategoryLegend(data.category_breakdown);
                        
                        // Update trend chart (with mock data for now)
                        updateTrendChart(generateMockTrendData(period, data.total_spent));
                        
                        // Update comparison chart (with mock data)
                        updateComparisonChart(data.category_percentages);
                        
                        // Display saving suggestions
                        displaySuggestions(data.saving_suggestions);
                        
                        // Update additional insights
                        updateTopCategories(data.category_breakdown);
                        updateTrendInsight(data.total_spent, period);
                    })
                    .catch(error => {
                        console.error('Error fetching insights:', error);
                        // Show error message
                        document.getElementById('suggestionsContainer').innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-exclamation-circle text-danger" style="font-size: 2rem;"></i>
                                <p class="mt-3">Failed to load insights: ${error.message}</p>
                                <button class="btn btn-outline-primary btn-sm mt-2" onclick="fetchInsights()">
                                    <i class="fas fa-sync-alt mr-2"></i>Retry
                                </button>
                            </div>
                        `;
                    });
            }
            
            // Function to fetch free alternatives based on user's bills
            function fetchFreeAlternatives() {
                const slider = document.getElementById('alternativesSlider');
                
                // Show loading spinner
                slider.innerHTML = `
                    <div class="text-center w-100 py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Finding alternatives...</span>
                        </div>
                        <p class="mt-3 text-muted">Analyzing your bills for potential savings...</p>
                    </div>
                `;
                
                // Fetch alternatives from API
                fetch(`${getApiBaseUrl()}/free-alternatives`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Clear container
                        slider.innerHTML = '';
                        
                        // Add each alternative
                        data.alternatives.forEach(alt => {
                            const altCard = createAlternativeCard(alt);
                            slider.appendChild(altCard);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching alternatives:', error);
                        
                        // Show error and load default alternatives
                        slider.innerHTML = `
                            <div class="text-center w-100 mb-4">
                                <p class="text-muted"><i class="fas fa-info-circle mr-2"></i>Using general recommendations</p>
                            </div>
                        `;
                        
                        // Add default alternatives
                        const defaults = [
                            {
                                paid_service: "Spotify Premium",
                                paid_amount: 9.99,
                                free_alternative: "YouTube Music",
                                savings: 120,
                                logo_hint: "spotify",
                                free_logo_hint: "youtube"
                            },
                            {
                                paid_service: "Netflix",
                                paid_amount: 15.49,
                                free_alternative: "Tubi TV",
                                savings: 186,
                                logo_hint: "film",
                                free_logo_hint: "tv"
                            },
                            {
                                paid_service: "Microsoft 365",
                                paid_amount: 6.99,
                                free_alternative: "LibreOffice",
                                savings: 84,
                                logo_hint: "file-word",
                                free_logo_hint: "file-alt"
                            }
                        ];
                        
                        defaults.forEach(alt => {
                            const altCard = createAlternativeCard(alt);
                            slider.appendChild(altCard);
                        });
                    });
            }
            
            // Function to create an alternative card from data
            function createAlternativeCard(alt) {
                const card = document.createElement('div');
                card.className = 'alternative-card';
                
                // Get appropriate logo hints
                const paidLogoClass = getLogoClass(alt.logo_hint || 'question');
                const freeLogoClass = getLogoClass(alt.free_logo_hint || 'question');
                
                // Calculate yearly savings with dollar sign and comma formatting
                const yearlySavings = Math.round(alt.savings || (alt.paid_amount * 12));
                const formattedSavings = yearlySavings.toLocaleString('en-US');
                
                card.innerHTML = `
                    <div class="savings-badge">Save $${formattedSavings}/year</div>
                    <div class="paid-service">
                        <div class="service-logo ${paidLogoClass}">
                            <i class="fab fa-${alt.logo_hint || 'question'}"></i>
                            <span class="service-premium-tag">Paid</span>
                        </div>
                        <div class="service-name">${alt.paid_service}</div>
                        <div class="service-price">$${typeof alt.paid_amount === 'number' ? alt.paid_amount.toFixed(2) : alt.paid_amount}/mo</div>
                    </div>
                    <div class="alternative-arrow">
                        <i class="fas fa-long-arrow-alt-right"></i>
                    </div>
                    <div class="free-service">
                        <div class="service-logo ${freeLogoClass}">
                            <i class="fa${alt.free_logo_hint && alt.free_logo_hint.startsWith('fa-') ? 's' : 'b'} fa-${alt.free_logo_hint || 'question'}"></i>
                            <span class="service-free-tag">Free</span>
                        </div>
                        <div class="service-name">${alt.free_alternative}</div>
                        <div class="service-price free">$0.00</div>
                    </div>
                `;
                
                return card;
            }
            
            // Function to get logo class from hint
            function getLogoClass(hint) {
                const logoMap = {
                    'spotify': 'premium',
                    'youtube': 'youtube',
                    'film': 'netflix',
                    'tv': 'tubi',
                    'discord': 'disney',
                    'play': 'pluto',
                    'file-word': 'office',
                    'file-alt': 'libre',
                    'amazon': 'amazon',
                    'apple': 'apple'
                };
                
                return logoMap[hint] || 'premium';
            }
            
            // Function to display saving suggestions
            function displaySuggestions(suggestions) {
                const container = document.getElementById('suggestionsContainer');
                
                // Parse suggestions from Gemini response
                let parsedSuggestions = parseSuggestions(suggestions);
                
                // Create suggestion card
                container.innerHTML = `
                    <div class="suggestion-card">
                        <h6 class="suggestion-title">Ways to Save Money</h6>
                        <ul class="suggestion-list">
                            ${parsedSuggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="mt-4">
                        <h6 class="mb-3">Additional Saving Strategies</h6>
                        <div class="accordion" id="savingStrategies">
                            <div class="card">
                                <div class="card-header" id="headingOne">
                                    <h2 class="mb-0">
                                        <button class="btn btn-link btn-block text-left p-0" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                            Find Free Alternatives
                                        </button>
                                    </h2>
                                </div>
                                <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#savingStrategies">
                                    <div class="card-body">
                                        Consider free alternatives to paid services. For streaming, try services like Pluto TV or use free trials strategically. Replace paid apps with free open-source alternatives.
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header" id="headingTwo">
                                    <h2 class="mb-0">
                                        <button class="btn btn-link btn-block text-left collapsed p-0" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                            Bundle Services
                                        </button>
                                    </h2>
                                </div>
                                <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#savingStrategies">
                                    <div class="card-body">
                                        Look for bundle options that combine multiple services at a discount. Many providers offer internet + streaming bundles or family plans that can significantly reduce overall costs.
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header" id="headingThree">
                                    <h2 class="mb-0">
                                        <button class="btn btn-link btn-block text-left collapsed p-0" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                            Negotiate Better Rates
                                        </button>
                                    </h2>
                                </div>
                                <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#savingStrategies">
                                    <div class="card-body">
                                        Call your service providers and negotiate better rates. Many companies have retention departments that can offer discounts to keep your business. Don't be afraid to mention competitor offers.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Helper function to parse suggestions from Gemini response
            function parseSuggestions(text) {
                try {
                    // Parse bullet points from Gemini response
                    const bullets = text.split(/|-|\*/g).filter(item => item.trim().length > 0).map(item => item.trim());
                    if (bullets.length >= 3) {
                        return bullets.slice(0, 3);
                    } else {
                        return defaultSuggestions;
                    }
                } catch (error) {
                    console.error('Error parsing suggestions:', error);
                    return defaultSuggestions;
                }
            }
            
            // Default suggestions if parsing fails
            const defaultSuggestions = [
                "Review and cancel unused subscription services",
                "Switch to more affordable alternatives for frequently used services",
                "Look for bundle deals to reduce overall costs"
            ];
            
            // Add horizontal scroll functionality to alternatives slider
            const slider = document.querySelector('.alternatives-slider');
            if (slider) {
                // Enable mouse wheel horizontal scrolling
                slider.addEventListener('wheel', function(event) {
                    if (event.deltaY) {
                        event.preventDefault();
                        slider.scrollLeft += event.deltaY;
                    }
                });
                
                // Add touch scrolling for mobile devices
                let isDown = false;
                let startX;
                let scrollLeft;
                
                slider.addEventListener('mousedown', (e) => {
                    isDown = true;
                    slider.style.cursor = 'grabbing';
                    startX = e.pageX - slider.offsetLeft;
                    scrollLeft = slider.scrollLeft;
                });
                
                slider.addEventListener('mouseleave', () => {
                    isDown = false;
                    slider.style.cursor = 'grab';
                });
                
                slider.addEventListener('mouseup', () => {
                    isDown = false;
                    slider.style.cursor = 'grab';
                });
                
                slider.addEventListener('mousemove', (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - slider.offsetLeft;
                    const walk = (x - startX) * 2;
                    slider.scrollLeft = scrollLeft - walk;
                });
            }
            
            // Function to update category chart
            function updateCategoryChart(categoryData) {
                const ctx = document.getElementById('categoryChart').getContext('2d');
                
                // Extract labels and values from data
                const labels = Object.keys(categoryData);
                const values = Object.values(categoryData);
                
                // Get colors for each category
                const backgroundColors = labels.map(category => categoryColors[category] || 'rgba(108, 117, 125, 0.7)');
                
                // Destroy existing chart if it exists
                if (categoryChart) categoryChart.destroy();
                
                // Create new chart
                categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: backgroundColors,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${context.label}: $${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Function to create category legend
            function createCategoryLegend(categoryData) {
                const legendContainer = document.getElementById('categoryLegend');
                legendContainer.innerHTML = '';
                
                Object.entries(categoryData).forEach(([category, amount]) => {
                    const total = Object.values(categoryData).reduce((a, b) => a + b, 0);
                    const percentage = ((amount / total) * 100).toFixed(1);
                    
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    
                    const color = categoryColors[category] || 'rgba(108, 117, 125, 0.7)';
                    
                    legendItem.innerHTML = `
                        <div class="color-indicator" style="background-color: ${color}"></div>
                        <div>${category}: $${amount.toFixed(2)} (${percentage}%)</div>
                    `;
                    
                    legendContainer.appendChild(legendItem);
                });
            }
            
            // Function to generate mock trend data
            function generateMockTrendData(period, totalAmount) {
                const currentDate = new Date();
                const labels = [];
                const data = [];
                
                let months = 3; // Default for quarter
                
                if (period === 'month') {
                    months = 1;
                } else if (period === 'year') {
                    months = 12;
                } else if (period === 'all') {
                    months = 24;
                }
                
                // Generate monthly labels backward from current month
                for (let i = months - 1; i >= 0; i--) {
                    const date = new Date(currentDate);
                    date.setMonth(currentDate.getMonth() - i);
                    const month = date.toLocaleString('default', { month: 'short' });
                    const year = date.getFullYear();
                    labels.push(`${month} ${year}`);
                    
                    // Generate some realistic looking random data
                    const baseAmount = totalAmount / months;
                    const randomFactor = 0.8 + Math.random() * 0.4; // Random between 0.8 and 1.2
                    data.push((baseAmount * randomFactor).toFixed(2));
                }
                
                return {
                    labels: labels,
                    data: data
                };
            }
            
            // Function to update trend chart
            function updateTrendChart(trendData) {
                const ctx = document.getElementById('trendChart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (trendChart) trendChart.destroy();
                
                // Create gradient
                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(67, 97, 238, 0.4)');
                gradient.addColorStop(1, 'rgba(67, 97, 238, 0.0)');
                
                // Create new chart
                trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: trendData.labels,
                        datasets: [{
                            label: 'Monthly Spending',
                            data: trendData.data,
                            borderColor: 'rgba(67, 97, 238, 1)',
                            borderWidth: 3,
                            pointBackgroundColor: 'rgba(67, 97, 238, 1)',
                            pointRadius: 4,
                            tension: 0.3,
                            fill: true,
                            backgroundColor: gradient
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value;
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return '$' + context.formattedValue;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Function to update comparison chart
            function updateComparisonChart(categoryPercentages) {
                const ctx = document.getElementById('comparisonChart').getContext('2d');
                
                // Create comparison data
                const labels = Object.keys(categoryPercentages);
                const userPercentages = Object.values(categoryPercentages);
                
                // Fetch actual comparison data from the server
                fetch(`${getApiBaseUrl()}/category-comparison`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch comparison data');
                        }
                        return response.json();
                    })
                    .then(avgData => {
                        // Get average percentages from the actual database
                        const avgPercentages = labels.map(category => 
                            avgData[category] || 0
                        );
                        
                        // Render the chart with real data
                        renderComparisonChart(ctx, labels, userPercentages, avgPercentages, 'Average User');
                        
                        // Update comparison insight text with real data
                        updateComparisonInsight(userPercentages, avgPercentages, labels);
                    })
                    .catch(error => {
                        console.error('Error fetching comparison data:', error);
                        
                        // Fallback to mock data if API call fails
                        const mockAverages = {
                            'Utilities': 15,
                            'Entertainment': 10,
                            'Subscriptions': 8,
                            'Insurance': 12,
                            'Rent': 30,
                            'Transportation': 10,
                            'Food': 12,
                            'Other': 3
                        };
                        
                        const avgPercentages = labels.map(category => 
                            mockAverages[category] || Math.random() * 15
                        );
                        
                        // Render chart with mock data
                        renderComparisonChart(ctx, labels, userPercentages, avgPercentages, 'Average User (Estimated)');
                        
                        // Update insights with mock data
                        updateComparisonInsight(userPercentages, avgPercentages, labels);
                    });
            }
            
            // Function to render the comparison chart (extracted to avoid code duplication)
            function renderComparisonChart(ctx, labels, userPercentages, avgPercentages, comparisonLabel) {
                // Destroy existing chart if it exists
                if (comparisonChart) comparisonChart.destroy();
                
                // Create new chart
                comparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Your Spending',
                                data: userPercentages,
                                backgroundColor: 'rgba(67, 97, 238, 0.7)',
                                borderColor: 'rgba(67, 97, 238, 1)',
                                borderWidth: 1
                            },
                            {
                                label: comparisonLabel,
                                data: avgPercentages,
                                backgroundColor: 'rgba(108, 117, 125, 0.3)',
                                borderColor: 'rgba(108, 117, 125, 0.7)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Percentage of Budget'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.formattedValue + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Enhanced comparison insight function with more details
            function updateComparisonInsight(userPercentages, avgPercentages, categories) {
                const insightElement = document.getElementById('comparisonInsight');
                
                // Find the categories with significant differences
                const differences = categories.map((category, index) => {
                    return {
                        category: category,
                        diff: userPercentages[index] - avgPercentages[index],
                        userPct: userPercentages[index],
                        avgPct: avgPercentages[index]
                    };
                });
                
                // Sort by absolute difference (largest first)
                differences.sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff));
                
                // Get the category with the highest difference
                const highestDiff = differences[0];
                
                // Generate insight text
                if (Math.abs(highestDiff.diff) < 3) {
                    insightElement.innerHTML = 'Your spending is very close to the average across all categories.';
                } else {
                    const diffText = Math.abs(highestDiff.diff).toFixed(1);
                    
                    if (highestDiff.diff > 0) {
                        // Spending more than average
                        insightElement.innerHTML = `
                            You spend <span class="text-danger">${diffText}% more</span> on 
                            <strong>${highestDiff.category}</strong> than the average person 
                            (${highestDiff.userPct.toFixed(1)}% vs ${highestDiff.avgPct.toFixed(1)}%). 
                            Consider reviewing your expenses in this category for potential savings.
                        `;
                    } else {
                        // Spending less than average
                        insightElement.innerHTML = `
                            You spend <span class="text-success">${diffText}% less</span> on 
                            <strong>${highestDiff.category}</strong> than the average person 
                            (${highestDiff.userPct.toFixed(1)}% vs ${highestDiff.avgPct.toFixed(1)}%). 
                            Good job managing expenses in this category!
                        `;
                    }
                    
                    // Add second insight if there's another significant difference
                    if (differences.length > 1 && Math.abs(differences[1].diff) > 5) {
                        const secondDiff = differences[1];
                        const secondDiffText = Math.abs(secondDiff.diff).toFixed(1);
                        
                        if (secondDiff.diff > 0) {
                            insightElement.innerHTML += `<br><br>You also spend <span class="text-danger">${secondDiffText}% more</span> on <strong>${secondDiff.category}</strong> than average.`;
                        } else {
                            insightElement.innerHTML += `<br><br>You also spend <span class="text-success">${secondDiffText}% less</span> on <strong>${secondDiff.category}</strong> than average.`;
                        }
                    }
                }
            }
            
            // Function to update chart themes based on dark mode
            function updateChartsTheme(isDarkMode) {
                // Set Chart.js global defaults based on theme
                Chart.defaults.color = isDarkMode ? '#f5f5f5' : '#666';
                Chart.defaults.scale.grid.color = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
                
                // Update each chart if they exist
                if (categoryChart) {
                    categoryChart.update();
                }
                
                if (trendChart) {
                    trendChart.update();
                }
                
                if (comparisonChart) {
                    comparisonChart.update();
                }
            }
            
            // Function to update top categories in the new insights card
            function updateTopCategories(categoryData) {
                const container = document.getElementById('topCategoriesContainer');
                
                // Sort categories by amount (descending)
                const sortedCategories = Object.entries(categoryData)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3); // Get top 3 categories
                
                // Calculate total for percentages
                const total = Object.values(categoryData).reduce((sum, val) => sum + val, 0);
                
                // Generate HTML for top categories
                let html = '';
                
                sortedCategories.forEach(([category, amount]) => {
                    const percentage = ((amount / total) * 100).toFixed(1);
                    const color = categoryColors[category] || 'rgba(108, 117, 125, 0.7)';
                    
                    html += `
                    <div class="mb-3">
                        <div class="category-label">
                            <span class="name">${category}</span>
                            <span class="amount">$${amount.toFixed(2)} (${percentage}%)</span>
                        </div>
                        <div class="progress category-progress">
                            <div class="progress-bar" role="progressbar" style="width: ${percentage}%; background-color: ${color};" 
                                aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            // Function to update trend insight text
            function updateTrendInsight(totalSpent, period) {
                const insightElement = document.getElementById('trendInsight');
                
                // Generate different insights based on period
                let timeText = '';
                let averageText = '';
                
                switch(period) {
                    case 'month':
                        timeText = 'this month';
                        averageText = `about $${(totalSpent / 30).toFixed(2)} per day`;
                        break;
                    case 'quarter':
                        timeText = 'this quarter';
                        averageText = `about $${(totalSpent / 3).toFixed(2)} per month`;
                        break;
                    case 'year':
                        timeText = 'this year';
                        averageText = `about $${(totalSpent / 12).toFixed(2)} per month`;
                        break;
                    default:
                        timeText = 'overall';
                        averageText = 'spread across various time periods';
                }
                
                insightElement.innerHTML = `
                    <i class="fas fa-info-circle mr-2"></i>
                    You've spent <strong>$${totalSpent.toFixed(2)}</strong> ${timeText}, which is ${averageText}.
                `;
            }
        });
    </script>
</body>
</html>
